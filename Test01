#!/bin/bash

# Set time zone
timedatectl set-timezone America/New_York

# Set locale
locale-gen en_US.UTF-8
update-locale LANG=en_US.UTF-8

# Move sshd to listen on port 2498
sed -i 's/#Port 22/Port 2498/g' /etc/ssh/sshd_config
systemctl restart sshd

# Deny remote login as root user
sed -i 's/PermitRootLogin yes/PermitRootLogin no/g' /etc/ssh/sshd_config
systemctl restart sshd

# Add serviceuser account to system
adduser serviceuser --gecos "" --disabled-password

# Grant sudo rights to serviceuser
usermod -aG sudo serviceuser

# Limit serviceuser sudo rights to start|stop|restart services
echo "serviceuser ALL=NOPASSWD: /bin/systemctl start *, /bin/systemctl stop *, /bin/systemctl restart *" >> /etc/sudoers.d/serviceuser

# Install Nginx and Monit servers and configure them to autostart on reboot
apt-get update
apt-get install -y nginx monit
systemctl enable nginx
systemctl enable monit

# Set up Nginx to proxy requests to the Monit server with basic auth using devops/test credentials
cat <<EOF > /etc/nginx/sites-available/monit
server {
    listen 80;
    server_name monit.example.com;

    location / {
        proxy_pass http://127.0.0.1:2812;
        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;
    }
}

EOF

htpasswd -cb /etc/nginx/.htpasswd devops test
ln -s /etc/nginx/sites-available/monit /etc/nginx/sites-enabled/
systemctl restart nginx
